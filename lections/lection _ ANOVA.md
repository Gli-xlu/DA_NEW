
## Анализ данных. доп. главы.  Лекция 1

### Anova (ANalysis Of VAriance) 

#### Дисперсионный анализ



Дисперсионный анализ — метод в математической статистике, направленный на поиск зависимостей в экспериментальных данных путём исследования значимости различий в средних значениях. 

Дисперсионный анализ – представляет собой комплекс статистических подходов для анализа результатов наблюдений, зависящих от различных одновременно действующих факторов, включающий методы для выбора наиболее важных факторов и оценку их влияния.

В отличие от t-критерия, позволяет сравнивать средние значения трёх и более групп. 

Разработан Р. Фишером для анализа результатов экспериментальных исследований. В литературе также встречается обозначение ANOVA (от англ. ANalysis Of VAriance)



Формулировка. Имеется несколько независимых групп наблюдений/измерений, выполненных в различных условиях эксперимента. Требуется установить, влияют ли условиях эксперимента на получаемые в группах измерения?

В терминах математической статистики задача формализуется как задача множественного сравнения средних значений, соответствующих каждой из групп.

![image.png](attachment:image.png)

## Пример из электронной коммерции. 

Зависимая переменная - предпочтение к приобретению товаров через Интернет; 
факторы – экономический и социальный риски такого приобретения (каждый из факторов имеет по два уровня:  «высокий» и «низкий»). Примененный маркетологами  дисперсионный анализ выявил существенное взаимодействие обоих.  
Например, приобретение через Интернет не является предпочтительным для товаров высокого социального 
риска (модная одежда) независимо от уровня экономического риска таких покупок. Иными словами, если неудачная покупка (сколько бы она ни стоила) грозит, например, резко уронить персону в глазах социальногоокружения, то человек предпочитае тпокупать товар лично, недоверяясь Интернет-рекламе. С другой стороны, если возможные потери от приобретения товара (некачественного или по другим причинам н еподходящего) с низким социальным риском малы, то их покупка через Интерне тпредпочтительнее (удобства, экономия времени и пр. берут верх), чем дорогих товаров с тем же уровнем социального риска.




### Суть дисперсионного анализа сводится к изучению влияния одной или нескольких независимых переменных, обычно именуемых факторами, на зависимую переменную.
 


##### В зависимости от типа и количества переменных различают:

•	однофакторный и многофакторный дисперсионный анализ (одна или несколько независимых переменных);

•	одномерный и многомерный дисперсионный анализ (одна или несколько зависимых переменных);


•	дисперсионный анализ с повторными измерениями (для зависимых выборок);

•	дисперсионный анализ с постоянными факторами, случайными факторами, и смешанные модели с факторами обоих типов;




```python

```

Нулевой гипотезой в дисперсионном анализе является утверждение о равенстве средних значений.

При отклонении нулевой гипотезы принимается альтернативная гипотеза о том, что не все средние равны, то есть имеются, по крайней мере, две группы, отличающиеся средними значениями.


## Однофакторный дисперсионный анализ

![image.png](attachment:image.png)

![image.png](attachment:image.png)

Простейшим случаем дисперсионного анализа является одномерный однофакторный анализ для двух или нескольких независимых групп, когда все группы объединены по одному признаку. 

В дисперсионном анализе исследуется влияние одного или нескольких качественных показателей на количественный показатель.

В однофакторном дисперсионном анализе на одну количественную переменную $X$ влияет один фактор (один качественный показатель), 

наблюдаемый на $k$ уровнях, то есть имеем $k$ выборок для переменной $X$. В ходе анализа проверяется нулевая гипотеза о равенстве средних.



######  При анализе двух групп дисперсионный анализ тождественен двухвыборочному t-критерию Стьюдента для независимых выборок, и величина F-статистики равна квадрату соответствующей t-статистики.



Предположения классической схемы однофакторного дисперсионного анализа относительно выборочных данных 
данные внутри групп получены из нормального распределения;
внутригрупповые дисперсии данных одинаковы;
данные независимы;

![image.png](attachment:image.png)

![image.png](attachment:image.png)

## Критерий Фишера

![image.png](attachment:image.png)

![image.png](attachment:image.png)

#### Функция плотности распределения Фишера- критерий Фишера. 
Xтобы проверить нулевую гипотезу Н0: μ1 = μ2 = … = μk и альтернативную гипотезу Н1: не все μj одинаковы j = 1, 2, …, k), необходимо вычислить статистику F-критерия, представляющую собой отношение двух дисперсий, MSA и MSW. 


Статистика F-критерия подчиняется F-распределению с K – 1 степенями свободы в числителе MSA и N – K степенями свободы в знаменателе MSW. При заданном уровне значимости α нулевая гипотеза отклоняется, если вычисленная F-статистика больше верхнего критического значения FU.
Таким образом, как показано на рис, решающее правило формулируется следующим образом: 

### нулевая гипотеза Н0 отклоняется, если F > FU; в противном случае она не отклоняется.

![image.png](attachment:image.png)

Если Fнабл> Fтабл, то отвергнута гипотеза Н0 и принята гипотеза Н1 и свероятностью ошибки α можно утверждать, что влияние рассматриваемого фактора на результативный признак существенно.
![image.png](attachment:image.png)

![image.png](attachment:image.png)

![image.png](attachment:image.png)


Межгрупповая дисперсия меньше внутригрупповой----> подтверждает нулевую гипотезу. Для проверки данной догадки, пользуемся дисперсионным анализом.

Вывод:

Для каждого признака из датасета мы можем посчитать его выразительную способность.

Т.е мы можем получить число, показывающее насколько сильно данный признак различается между различными классами из X . Упрощенное объяснение следующее.

Используем знания о метках класса X .

Считаем дисперсию данного признака внутри каждого класса из X .

Считаем дисперсию данного признака между группами, которые задает X .

Финальный скор это -- отношение дисперсии между группами к дисперсии внутри групп.

Для лучшего понимания посмотреть видео https://www.youtube.com/watch?v=ITf4vHhyGpc&feature=youtu.be (тут интуиция) и видео https://www.youtube.com/watch?v=-yQb_ZJnFXw (тут математика).

Такой скоринг можно использовать для ранжирования признаков по их значимости.

Реализация из sklearn позволяет заранее задать число признаков, которое мы хотим оставить исходя из полученных с помощью метода ANOVA скоров.

Предположения метода:

1 выборочные распределения средних значений признака во всехгруппах нормальны;

2 дисперсия значений признака во всех группах одинакова;

3 наблюдения независимы.

Первое предположение считается выполненным, если распределениепризнака во всех группах нормально, или если объёмы выборокпримерно одинаковы и N−K−1≥20.

Второе предположение считается выполненным, если отношениенаибольшей выборочной дисперсии к наименьшей не превосходит 10.

При n1=···=nK метод устойчив к нарушению первых двухпредположений.Если объёмы выборок различаются, нарушение предположенияо равенстве дисперсий может привести к росту вероятности ошибкипервого рода.

Выбросы могут оказывать существенное влияние на результат.Рябенко ЕвгенийПСАД-5. Дисперсионный анализ.

 #### F-тест работает только с нормальными выборками---->Нужна проверка на нормальность- тесты


![image.png](attachment:image.png)

#### По шагам:

Наблюдаемые данные обозначим $y_{ij}$, где $i$ — индекс уровня ($i$ = 1, 2, ..., $k$), $j$ — индекс наблюдения на $i$-м уровне 
($j$ = 1, 2, ..., $n_{i}$).

На каждом уровне может быть свое число наблюдений $n_{i}$. Общее число наблюдений — это сумма наблюдений на всех уровнях:

$$n = \sum\limits_{i=1}^{k}n_i$$

По данным $y_{ij}$ определяется:

$\overline{y}_{i}$ — среднее значение переменной Y на i-м уровне:

$$\overline{y}_{i} = \frac{1}{n_i}\sum\limits_{j=1}^{n_i}y_{ij}$$

$\overline{Y}$ — среднее значение переменной **Y** по всем значениям:

$$\overline{Y} = \frac{1}{n}\sum\limits_{i=1}^{k}\sum\limits_{j=1}^{n_i}y_{ij} = \frac{1}{n}\sum\limits_{i=1}^{k}\overline{y}_{i}n_{i}$$

$S^2$ — сумма квадратов отклонений наблюдений от общего среднего:

$$S^2 = \sum\limits_{i=1}^{k}\sum\limits_{j=1}^{n_i}({y}_{ij} - \overline{Y})^2$$

$S_F^2$ — сумма квадратов отклонений средних групповых значений от общего среднего значения $\overline{Y}$:

$$S_F^2 = \sum\limits_{i=1}^{k}(\overline{y}_i - \overline{Y})^2n_i$$

$S_{ост}^2$ — остаточная сумма квадратов отклонений:

$$S_{ост}^{2} = \sum\limits_{i=1}^{k}\sum\limits_{j=1}^{n_i}(y_{ij} - \overline{y}_i)^2$$

Тогда сумма квадратов отклонений наблюдений от общего среднего дожна быть равна:

$$S^2 = S_F^2 + S_{ост}^2$$

Затем необходимо вычислить:

1) общую дисперсию:

$$\sigma_{общ}^{2} = \frac{S^2}{n - 1} = \frac{1}{n-1}\sum\limits_{i=1}^{k}\sum\limits_{j=1}^{n_i}(y_{ij} - \overline{Y})^2$$

2) факторную дисперсию:

$$\sigma_{F}^{2} = \frac{S_{F}^{2}}{k-1} = \frac{1}{k-1}\sum\limits_{i=1}^{k}(\overline{y}_i - \overline{Y})^{2}n_i$$

3) остаточную дисперсию:

$$\sigma_{ост}^{2} = \frac{S_{ост}^{2}}{n - k} = \frac{1}{n - k}\sum\limits_{i=1}^{k}\sum\limits_{j=1}^{n_i}(y_{ij} - \overline{y}_i)^2$$

В дисперсионном анализе проверяется гипотеза $H_0$ о равенстве средних групповых значений количественного показателя:

$$(H_0: \overline{y}_1 = \overline{y}_2 = ... = \overline{y}_k).$$

Чтобы проверить эту гипотезу, необходимо воспользоваться соотношением:

$$F_H = \frac{\sigma_{F}^{2}}{\sigma_{ост}^{2}}$$

Если значение  $F_H$ превышает $F_{крит}$ из таблицы критических точек распределения Фишера-Снедекора для заданного уровня 

значимости $\alpha$ двух степеней свободы $df_{межд} = k - 1$ (относится к числителю соотношения) и $df_{внутр} = n - k$ (относится к знаменателю), 

то выборки имеют разные средние значения.

Таблицы Фишера-Снедекора можно найти по ссылкам:

        
<a href = "https://www.matburo.ru/tv/table_fisher.pdf">Распределение Фишера–Снедекора (F-распределение)</a>

Еще одно соотношение:

$$\eta^{2} = \frac{S_{F}^{2}}{S_{общ}^{2}}$$

Чем больше значение $\eta^2$ (греч. «эта», обозначает эмпирическое корреляционное отношение, располагается между 0 и 1), тем больше

вероятность, что выборки имеют разные средние значения. Принято считать, что при значениях $\eta^2$ ниже 0.2-0.3 групповые значения

средних не имеют статистически достоверного отличия.

**Пример 1**

Среди людей, проживающих в одном городе, выделены три группы по качественному признаку — профессии: бухгалтеры, юристы, 

программисты. 

Рассмотрим количественный признак — заработную плату (в тысячах рублей).

Нужно установить, различаются ли средние зарплаты этих трех групп при уровне значимости $\alpha$, равном 0.05.

Количество человек в каждой группе: бухгалтеры — 5, юристы — 8, программисты — 7.


```python
import numpy as np
```


```python
n1 = 5
n2 = 8
n3 = 7
n = n1 + n2 + n3
print(n)
```

    20
    

Всего три группы:


```python
k = 3
```

Зарплаты бухгалтеров:


```python
y1 = np.array([70, 50, 65, 60, 75], dtype=np.float64)
```

Зарплаты юристов:


```python
y2 = np.array([80, 75, 90, 70, 75, 65, 85, 100], dtype=np.float64)
```

Зарплаты программистов:


```python
y3 = np.array([130, 100, 140, 150, 160, 170, 200], dtype=np.float64)
```

Проведем однофакторный дисперсионный анализ. Сначала найдем средние зарплаты для каждой профессии:


```python
y1_mean = np.mean(y1)
print(y1_mean)
```

    64.0
    


```python
y2_mean = np.mean(y2)
print(y2_mean)
```

    80.0
    


```python
y3_mean = np.mean(y3)
print(y3_mean)
```

    150.0
    

Видно, что средние зарплаты разнятся. Установим, что это отличие статистически значимо. Для этого сначала соберем 

все значения заработных плат в один массив:


```python
y_all = np.concatenate([y1, y2, y3])
y_all
```




    array([  70.,   50.,   65.,   60.,   75.,   80.,   75.,   90.,   70.,
             75.,   65.,   85.,  100.,  130.,  100.,  140.,  150.,  160.,
            170.,  200.])



Найдем среднее значение заработной платы по всем значениям:


```python
y_mean = np.mean(y_all)
print(y_mean)
```

    100.5
    

Найдем $S^2$ — сумму квадратов отклонений наблюдений от общего среднего:


```python
s2 = np.sum((y_all - y_mean)**2)
s2
```




    34445.0



Найдем $S^2_F$ - сумму квадратов отклонений средних групповых значений от общего среднего:


```python
s2_f = ((y1_mean - y_mean)**2) * n1 + ((y2_mean - y_mean)**2) * n2 + ((y3_mean - y_mean)**2) * n3
s2_f
```




    27175.0



Найдем $S^2_{ост}$ — остаточную сумму квадратов отклонений:


```python
s2_residual = np.sum((y1 - y1_mean)**2) + np.sum((y2 - y2_mean)**2) + np.sum((y3 - y3_mean)**2)
s2_residual
```




    7270.0



Удостоверимся, что соблюдается равенство $S^2 = S_F^2 + S_{ост}^2$:


```python
print(s2)
print(s2_f + s2_residual)
```

    34445.0
    34445.0
    

Найдем общую дисперсию:


```python
sigma2_general = s2 / (n - 1)
sigma2_general
```




    1812.8947368421052



Найдем факторную дисперсию:


```python
sigma2_f = s2_f / (k - 1)
sigma2_f
```




    13587.5



Найдем остаточную дисперсию:


```python
sigma2_residual = s2_residual / (n - k)
sigma2_residual
```




    427.64705882352939



Вычислим $F_H$:


```python
F_h = sigma2_f / sigma2_residual
F_h
```




    31.772696011004129



Найдем значение $F_{крит}$ в таблице критических точек распределения Фишера-Снедекора для заданного уровня значимости $\alpha = 0.05$ и двух степеней свободы: 

$df_{межд} = k - 1 = 3 - 1 = 2$ и $df_{внутр} = n - k = 20 - 3 = 17$.

Для данных значений $F_{крит} = 3.59$. Так как $F_H > F_{крит}$, отвергнута гипотеза Н0, различие средних зарплат в трех группах статистически значимо.


```python

```


```python

```


```python

```


```python

```

![image.png](attachment:image.png)

![image.png](attachment:image.png)

![image.png](attachment:image.png)


```python

```


```python

```

# Двухфакторный дисперсионный анализ

![image.png](attachment:image.png)

![image.png](attachment:image.png)

В таблице представлены расчетные формулы для двухфакторного  
дисперсионного анализа с однократными наблюдениями.

<img src='https://ru.files.fm/thumb_show.php?i=vppqqgpj&view' width=650>Таблица 1. Формулы для двухфакторного дисперсионного анализа с однократными наблюдениями</img>

![image.png](attachment:image.png)


```python

```

## Дисперсионный анализ повзволяет решать такие задачи:

![image.png](attachment:image.png)

### Задание 1. Реализовать метод по примеру выше для расчета дисперсий к следующей задаче.
### Решить задачу, используя методы Anova SciPy.

Провести дисперсионный анализ для определения того, есть ли различия среднего роста среди взрослых футболистов, хоккеистов и штангистов. Даны значения роста в трех группах случайно выбранных спортсменов: Футболисты: 173, 175, 180, 178, 177, 185, 183, 182. Хоккеисты: 177, 179, 180, 188, 177, 172, 171, 184, 180. Штангисты: 172, 173, 169, 177, 166, 180, 178, 177, 172, 166, 170.

### Задание2. Проанализируйте набор данных «Авто-мили», чтобы выяснить, насколько переменные похожи друг на друга.

Загрузите набор данных auto-mpg из ~ / наборов данных / auto-mpg /
Проверить нулевую гипотезу, отклонять или не отклонять нулевую гипотезу.

1. Гипотезы:

Independent variable: origin

Dependent variable: mpg

$ H_o: $ Существенных различий в милях среди транспортных средств различного происхождения не существует.

$ H_1: $ Существенная разница существует в милях среди транспортных средств различного происхождения.
 
 2. 
 
Independent variable: origin

Independent variable: horsepower

Dependent variable: mpg

$ H_o: $ Существенных различий в милях среди транспортных средств различного происхождения не существует.

$ H_1: $ Существенная разница существует в милях среди транспортных средств различного происхождения.


 

Задание 3. Определить , какие выборки и  какой критерий использовать. 

1. Пример

Изучить, оказывает ли влияение новая недавно разработанная система электронной регистрации на прием к врачу на среднее время, проведенное пациентом в ожидании приема. Пусть есть две выборки  со средним временем ожидания приема за последний месяц в двух разных клиниках; в одной из них есть система электронной регистрации, а в другой – нет.
2. Пример

Для тестирования диеты набираются 15 человек. Их вес замеряется, а затем они подвергаются диете в течении некоторого времени, и их вес снова замеряется. С помощью статистических методов необходимо проверить, работает ли диета.

3. Пример

Влияние витамина C на рост зубов морских свинок.
В эксперименте изучалось влияние витамина C на рост одонтобластов морских свинок. Рассматривалось три дозы витамина (0.5, 1 и 2 мг) и два способа его приёма (апельсиновый сок и аскорбиновая кислота). В каждой из 6 групп по уровням двух факторов были произведены измерения для 10 морских свинок.

4. Пример

Рост певцов хора
В 1979 году было опрошено 235 членов нью-йоркской ассоциации хорового пения, для каждого из них известен рост и регистр голоса. Меняется ли средний рост вместе с регистром?


```python

```


```python

```
